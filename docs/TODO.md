# TODO 总览

## 最小可用字幕学习工具计划（2025-10-19）

### 背景
参考需求文档与设计原型，需要交付一个支持字幕分块、学习内容生成、笔记管理与导入导出的最小化工具。要求前后端同步实现，并复用现有 Spike4/Spike5 能力。

### 阶段 0：基础设施 ✅
- ✅ 搭建 Next.js + TypeScript + Tailwind 前端骨架，统一 App Router。
- ✅ 配置 API Route Handler，建立 `server/services` 与 `schema` 目录。
- ✅ 设置 `.env` / OpenAI 参数，预留日志与缓存路径。

### 阶段 1：字幕输入与情景分块（落地 Spike4） ✅
- ✅ 实现 `/api/subtitles/segment` 接口，封装 `segmentSubtitle` 服务逻辑。
- ✅ 前端提供字幕粘贴、拖拽、选择文件上传，以及分块结果展示。
- ✅ 单元测试覆盖 `segmentSubtitle` 服务（使用 Vitest + Mock OpenAI）。

### 阶段 2：情景深入分析（落地 Spike5） 🚧
- ✅ 实现 `/api/scenarios/analyze`，支持单模块调用，生成 Module1~5 Markdown。
- ✅ 前端完成左右布局，右侧可触发 Spike5 分析并渲染 Markdown，保留 hover 同步机制。
- 🚧 控制请求超时与 Token 消耗：
  - ✅ 服务层加入基础缓存（按模块内容哈希，1 小时失效）。
  - ✅ API 支持批量分析（一次传多个 block），并返回进度列表。
  - ✅ 前端提供“一键生成全部模块”按钮、禁用逻辑与局部进度展示。
  - [ ] 统计与展示 Token/耗时信息，优化并发策略（后续扩展）。

### 阶段 3：笔记与导入导出 🚧
- ✅ 支持悬停字幕行并创建笔记，记录 `blockIndex` / `order` 关联信息。
- ✅ 实现 `/api/notes/export`，输出包含情景、学习分析与笔记的 Markdown。
- ✅ 实现 `/api/notes/import`，解析 Markdown 并恢复字幕-笔记关联及分析结果。
- [ ] 笔记数据的持久化与同步策略（后续探索）。

### 阶段 4：用户配置与管理
- ✅ 提供配置界面，允许调整模型、温度、缓存时长、导出模板。
- ✅ 配置存储于 LocalStorage（预留服务端持久化方案）。
- [ ] 支持导出配置 / 恢复默认设置。

### 阶段 5：体验打磨与扩展
- [ ] 增补 Loading、错误提示、进度条等体验细节。
- [ ] 支持字幕/笔记搜索、过滤，提供常用快捷操作。
- [ ] 预留音视频同步接口及播放器集成方案。

> 开发前需同步更新设计/技术说明，服务层保持与 Spike 代码兼容，便于复用测试用例并加速迭代。
